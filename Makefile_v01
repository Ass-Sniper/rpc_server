CC = g++
CXXFLAGS = -std=c++11 -I./include -I/usr/include/event2 -I/usr/include/nlohmann -Wall -O2
#CXXFLAGS += -Iextern/json
LDFLAGS = -L./lib \
          -lframework \
          -lservices \
          -levent_openssl \
          -levent \
          -lpthread \
          -lssl \
          -lcrypto

FRAMEWORK_SRC = $(wildcard src/framework/*.cpp)
SERVICES_SRC = $(wildcard src/services/*.cpp)

LIB_OBJS =  $(patsubst src/framework/%.cpp, build/framework/%.o, $(FRAMEWORK_SRC))	\
	$(patsubst src/services/%.cpp, build/services/%.o, $(SERVICES_SRC))

MKDIR = mkdir -p

$(info ========== Makefile Debug Info ==========)
$(info FRAMEWORK_SRC: $(FRAMEWORK_SRC))
$(info LIB_OBJS: $(LIB_OBJS))

all: prepare libs server

prepare:
	@$(MKDIR) build/framework
	@$(MKDIR) build/services
	@$(MKDIR) lib

# 编译规则
build/framework/%.o: src/framework/%.cpp
	@echo "[DEBUG] Compiling $< ->   $@"
	@mkdir -p $(@D)
	$(CC) $(CXXFLAGS) -c  $< -o $@

libframework.a: $(LIB_OBJS)
	@echo "Building libframework.a"
	ar rcs lib/$@   $^

build/services/%.o: src/services/%.cpp
	@echo "[SERVICE] Compiling: $< -> $@"
	@$(MKDIR) $(@D)
	$(CC) $(CXXFLAGS) -c $< -o $@

libservices.a: $(LIB_OBJS)
	@echo "Linking service library: $@"
	ar rcs lib/$@ $^

server: main.cpp libframework.a libservices.a
	@echo "Building main executable: $@"
	$(CC) $(CXXFLAGS) $< -o $@ $(LDFLAGS)

cert:
	@echo "Generating HTTPS certificates"
	@mkdir -p cert
	openssl req -x509 -newkey rsa:4096 -nodes \
		-keyout cert/server.key -out cert/server.crt -days 365 \
		-subj "/CN=localhost"

# 清理构建产物
clean:
	@rm -rf build
	@rm -rf lib
	@rm -f $(EXECUTABLE)

.PHONY: all prepare libs server cert clean
